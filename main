import logging
import random
import asyncio
from aiogram import Bot, Dispatcher, types
# –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç Command –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥
from aiogram.filters import BaseFilter, Command
from aiogram.types import Message

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
# –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –í–ê–® –ù–û–í–´–ô –°–ï–ö–†–ï–¢–ù–´–ô –¢–û–ö–ï–ù!
API_TOKEN = '8460276527:AAHOH5US5H2nzQHQdr_MoxMlrX_HxvKXvVg'
PHOTO_FILENAME = 'photo_2025-11-25_20-24-05.jpg'

TRIGGER_WORDS = [
    "—â—É–∫–∏–Ω–∞",
    "—â—É–∫–∞",
    "—à–ª—é—Ö–∏–Ω–∞",
    "—à–ª—é—Ö–∞",
    "—Å—É–∫–∏–Ω–∞"
]

GORE_OT_UMA_QUOTES = [
    "–ê —Å—É–¥—å–∏ –∫—Ç–æ",
    "–°—á–∞—Å—Ç–ª–∏–≤—ã–µ —á–∞—Å–æ–≤ –Ω–µ –Ω–∞–±–ª—é–¥–∞—é—Ç.",
    "–°–ª—É–∂–∏—Ç—å –±—ã —Ä–∞–¥, –ø—Ä–∏—Å–ª—É–∂–∏–≤–∞—Ç—å—Å—è —Ç–æ—à–Ω–æ",
    "–ê—Ö, –∑–ª—ã–µ —è–∑—ã–∫–∏ —Å—Ç—Ä–∞—à–Ω–µ–µ –ø–∏—Å—Ç–æ–ª–µ—Ç–∞."
]

# –ù–æ–≤—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ä–µ–∫–ª–∞–º—ã
ADVERTISEMENTS = [
    "üé£ **–û—Ç–∫—Ä–æ–π—Ç–µ –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —É–¥–æ–±—Å—Ç–≤–∞!**\n\n–ù–µ –ø—Ä–æ—Å—Ç–æ —Ü–∏—Ç–∞—Ç–∞, –∞ —Å–æ–≤–µ—Ç: –∑–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç—É —Å–∞–º—É—é –≥–æ–ª—É–±—É—é –∫–Ω–æ–ø–∫—É ¬´–©—É–∫–∞¬ª —Å–ª–µ–≤–∞. –≠—Ç–æ –Ω–∞—à –Ω–æ–≤—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ä–∞–∑–¥–µ–ª, –≥–¥–µ –≤—Å—ë —É—Å—Ç—Ä–æ–µ–Ω–æ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–æ–º—Ñ–æ—Ä—Ç–∞.",
    
    "üîç **–ò–Ω–æ–≥–¥–∞ —Å–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ —Å–∫—Ä—ã—Ç–æ –∑–∞ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π.**\n\n–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –∑–∞–π–¥–∏—Ç–µ –≤ –±–æ—Ç–∞ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –Ω–æ–≤—ã–π –º–∏—Ä ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–æ–ª—É–±—É—é –∫–Ω–æ–ø–∫—É ¬´–©—É–∫–∞¬ª –≤ –º–µ–Ω—é. –í–∞—à –∫–ª—é—á –∫ –Ω–æ–≤—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º.",
    
    "üöÄ **–ù–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ¬´–©—É–∫–∞¬ª —É–∂–µ –≤ –±–æ—Ç–µ!**\n\n–ß—Ç–æ–±—ã –æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ–≥–æ –ø–µ—Ä–≤—ã–º, –Ω–µ –Ω—É–∂–Ω–æ —Å–ª–æ–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π: –∑–∞–π–¥–∏—Ç–µ –≤ –±–æ—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–æ–ª—É–±—É—é –∫–Ω–æ–ø–∫—É ¬´–©—É–∫–∞¬ª –≤ –ª–µ–≤–æ–º –º–µ–Ω—é. –í—Å—ë –≥–µ–Ω–∏–∞–ª—å–Ω–æ–µ ‚Äî –ø—Ä–æ—Å—Ç–æ!",
    
    "üí´ **–ê –≤—ã —É–∂–µ –Ω–∞—à–ª–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ä–∞–∑–¥–µ–ª?**\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–±—è: –∑–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ –∏ –≤–∑–≥–ª—è–Ω–∏—Ç–µ –Ω–∞ –ª–µ–≤—É—é —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞. –¢–∞ —Å–∞–º–∞—è –≥–æ–ª—É–±–∞—è –∫–Ω–æ–ø–∫–∞ ¬´–©—É–∫–∞¬ª ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å –≤–∞—à –ø—Ä–æ–ø—É—Å–∫ –≤ –º–∏—Ä –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π. –ñ–º–∏—Ç–µ —Å–∫–æ—Ä–µ–µ!"
]

# ------------------

def format_quote_bold(quote: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ü–∏—Ç–∞—Ç—É, –¥–µ–ª–∞—è –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –∂–∏—Ä–Ω—ã–º —Å –ø–æ–º–æ—â—å—é **–º–∞—Ä–∫–¥–∞—É–Ω–∞."""
    words = quote.split()
    formatted_words = [f"**{word}**" for word in words]
    return " ".join(formatted_words)


def get_random_quote() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é —Ü–∏—Ç–∞—Ç—É, –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∂–∏—Ä–Ω—ã–º."""
    quote = random.choice(GORE_OT_UMA_QUOTES)
    return format_quote_bold(quote)


def get_random_advertisement() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é —Ä–µ–∫–ª–∞–º–Ω—É—é —Ü–∏—Ç–∞—Ç—É."""
    return random.choice(ADVERTISEMENTS)


# –ö–∞—Å—Ç–æ–º–Ω—ã–π –∫–ª–∞—Å—Å-—Ñ–∏–ª—å—Ç—Ä –¥–ª—è aiogram v3
class TriggerWordFilter(BaseFilter):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª—é–±–æ–µ —Å–ª–æ–≤–æ –∏–∑ —Å–ø–∏—Å–∫–∞ TRIGGER_WORDS."""

    async def __call__(self, message: Message) -> bool:
        if message.text:
            text_lower = message.text.lower()
            for word in TRIGGER_WORDS:
                if word in text_lower:
                    return True
        return False


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
async def send_photo_with_quote(message: Message):
    """–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º, –æ—Ç–ø—Ä–∞–≤–ª—è—è —Ñ–æ—Ç–æ –∏ —Ü–∏—Ç–∞—Ç—É."""

    # –°–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –≤—ã–±–∏—Ä–∞–µ–º –º–µ–∂–¥—É –æ–±—ã—á–Ω–æ–π —Ü–∏—Ç–∞—Ç–æ–π –∏ —Ä–µ–∫–ª–∞–º–æ–π
    if random.random() < 0.3:  # 30% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ–∫–∞–∑–∞ —Ä–µ–∫–ª–∞–º—ã
        caption_text = get_random_advertisement()
    else:
        caption_text = get_random_quote()

    try:
        photo_file = types.FSInputFile(PHOTO_FILENAME)

        await message.reply_photo(
            photo=photo_file,
            caption=caption_text,
            parse_mode="Markdown"
        )
        logging.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ç–æ –≤ —á–∞—Ç {message.chat.id} –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É: {message.text}")

    except FileNotFoundError:
        error_message = f"–û—à–∏–±–∫–∞: –§–∞–π–ª {PHOTO_FILENAME} –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å."
        await message.reply(error_message)
        logging.error(error_message)

    except Exception as e:
        logging.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ: {e}")


# –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /leave
async def leave_chat_command(message: Message, bot: Bot):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /leave, –∑–∞—Å—Ç–∞–≤–ª—è—è –±–æ—Ç–∞ –ø–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç."""
    chat_id = message.chat.id

    # 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—â–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await message.reply("–•–æ—Ä–æ—à–æ, –≤—ã–ø–æ–ª–Ω—è—é –∫–æ–º–∞–Ω–¥—É /leave. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")

    # 2. –ë–æ—Ç –ø–æ–∫–∏–¥–∞–µ—Ç —á–∞—Ç
    try:
        await bot.leave_chat(chat_id)
        logging.info(f"–ë–æ—Ç –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç —Å ID: {chat_id}")
    except Exception as e:
        # –ú–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å, –µ—Å–ª–∏ —É –±–æ—Ç–∞ –Ω–µ—Ç –ø—Ä–∞–≤ (–Ω–æ –æ–±—ã—á–Ω–æ –µ—Å—Ç—å)
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç {chat_id}: {e}")
        await message.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–æ–∏ –ø—Ä–∞–≤–∞.")


# –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /ad
async def send_advertisement_command(message: Message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /ad, –æ—Ç–ø—Ä–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ä–µ–∫–ª–∞–º—É."""
    caption_text = get_random_advertisement()
    
    try:
        photo_file = types.FSInputFile(PHOTO_FILENAME)

        await message.reply_photo(
            photo=photo_file,
            caption=caption_text,
            parse_mode="Markdown"
        )
        logging.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–µ–∫–ª–∞–º–∞ –ø–æ –∫–æ–º–∞–Ω–¥–µ /ad –≤ —á–∞—Ç {message.chat.id}")

    except FileNotFoundError:
        error_message = f"–û—à–∏–±–∫–∞: –§–∞–π–ª {PHOTO_FILENAME} –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å."
        await message.reply(error_message)
        logging.error(error_message)

    except Exception as e:
        logging.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∫–ª–∞–º—ã: {e}")


# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
async def main():
    bot = Bot(token=API_TOKEN)
    dp = Dispatcher()

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    # 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –ø–æ —Ç–µ–∫—Å—Ç—É
    dp.message.register(send_photo_with_quote, TriggerWordFilter())
    # 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã /leave
    dp.message.register(leave_chat_command, Command("leave"))
    # 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã /ad –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∫–ª–∞–º—ã
    dp.message.register(send_advertisement_command, Command("ad"))

    print("–ë–æ—Ç (aiogram v3) –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...")
    await dp.start_polling(bot, skip_updates=True)


if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é.")
